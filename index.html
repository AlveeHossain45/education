<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles for Font and Transitions */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Sidebar & Main Content Transitions */
        .sidebar { transition: transform 0.3s ease-in-out, background-color 0.3s, color 0.3s; }
        .main-content { transition: margin-left 0.3s ease-in-out, background-color 0.3s, color 0.3s; }

        /* Modal Styles */
        .modal, .confirm-modal {
            display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center;
            opacity: 0; transform: scale(0.9); transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .modal.show, .confirm-modal.show {
            opacity: 1; transform: scale(1);
        }
        .modal-content, .confirm-modal-content {
            background-color: #fefefe; padding: 25px; border-radius: 0.75rem; /* More rounded corners */
            border: 1px solid #e2e8f0; /* Subtle border */
            width: 90%; max-width: 600px; /* Slightly larger modals */
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); /* Deeper shadow for 3D feel */
            transform: translateY(-20px); /* Initial slight lift for animation */
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal.show .modal-content, .confirm-modal.show .confirm-modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .close-button {
            color: #9ca3af; /* Gray-400 */
            position: absolute; top: 15px; right: 20px; font-size: 28px; font-weight: bold;
            transition: color 0.2s;
        }
        .close-button:hover, .close-button:focus { color: #ef4444; /* Red-500 */ text-decoration: none; cursor: pointer; }

        /* Dark Mode for Modals */
        .dark .modal-content, .dark .confirm-modal-content {
            background-color: #1f2937; /* Darker charcoal */
            border-color: #374151; /* Darker gray border */
            color: #e5e7eb; /* Light text */
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }
        .dark .close-button { color: #a0aec0; /* Lighter gray */ }
        .dark .close-button:hover, .dark .close-button:focus { color: #f87171; /* Lighter red */ }

        /* Toast Notification */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 100;
        }
        .toast {
            background-color: #333; color: #fff; padding: 15px 20px; border-radius: 8px; /* More rounded */
            margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); /* Deeper shadow */
            opacity: 0; transition: opacity 0.5s ease-out, transform 0.5s ease-out; transform: translateX(100%);
            min-width: 250px; /* Ensures minimum width */
            display: flex; align-items: center;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast i { margin-right: 10px; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        /* Dark Mode Scrollbar */
        .dark ::-webkit-scrollbar-track { background: #1f2937; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Login Page - Beautiful Gradient & 3D Elements */
        #login-page {
            background: linear-gradient(135deg, #3f51b5, #2196f3, #42a5f5); /* Deeper Blue Gradient */
            color: #fff;
            position: relative;
            overflow: hidden;
        }
        #login-page::before { /* Background overlay for more depth */
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at top left, rgba(255,255,255,0.05), transparent 70%),
                        radial-gradient(circle at bottom right, rgba(255,255,255,0.05), transparent 70%);
            z-index: 1;
        }
        .login-form-wrapper {
            position: relative;
            z-index: 2; /* Ensure it's above the overlay */
            background: rgba(255, 255, 255, 0.1); /* Frosted glass effect */
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4); /* Stronger shadow for 3D pop */
            backdrop-filter: blur(15px); /* Increased blur */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Light border for definition */
            transform: perspective(1000px) rotateY(0deg) rotateX(0deg); /* Initial 3D state */
            transition: transform 0.5s ease;
        }
        .login-form-wrapper:hover {
            transform: perspective(1000px) rotateY(2deg) rotateX(2deg); /* Slight rotation on hover */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        .login-form-wrapper .fa-school {
            color: #FFEB3B; /* Yellow color for icon */
            text-shadow: 0 0 10px rgba(255, 235, 59, 0.5); /* Glowing effect */
            margin-bottom: 1.5rem;
        }
        .login-form-wrapper h2 {
            color: #fff;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .login-form-wrapper label {
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0.5px 0.5px 1px rgba(0,0,0,0.3);
        }
        .login-form-wrapper input {
            background-color: rgba(255, 255, 255, 0.2); /* Slightly more opaque */
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: #fff;
            padding: 12px 15px; /* More padding */
            border-radius: 8px; /* Rounded inputs */
            transition: all 0.3s ease;
        }
        .login-form-wrapper input::placeholder { /* Placeholder text color */
            color: rgba(255, 255, 255, 0.8);
        }
        .login-form-wrapper input:focus {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.4); /* Subtle focus ring */
            outline: none;
        }
        .login-form-wrapper .bg-blue-500 {
            background-color: #3f51b5; /* Deeper blue */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* Button shadow */
            transition: all 0.3s ease;
        }
        .login-form-wrapper .bg-blue-500:hover {
            background-color: #283593; /* Even deeper blue on hover */
            transform: translateY(-2px); /* Lift button on hover */
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }
        .login-form-wrapper .text-xs {
            color: rgba(255, 255, 255, 0.8);
        }
        #login-error {
            background-color: rgba(220, 38, 38, 0.25); /* Red with transparency */
            border-color: rgba(220, 38, 38, 0.6);
            color: #fee2e2; /* Light red text */
        }
        /* Profile Image Preview */
        .profile-image-preview {
            width: 120px; height: 120px; border-radius: 50%; object-fit: cover;
            border: 3px solid #cbd5e0; /* light-gray-300 */
            transition: border-color 0.3s ease;
        }
        .dark .profile-image-preview {
            border-color: #4a5568; /* dark-gray-600 */
        }
        .profile-image-upload-wrapper {
            position: relative; width: 120px; height: 120px; margin: 0 auto 1.5rem;
        }
        .profile-image-upload-wrapper input[type="file"] {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
        }
        .profile-image-upload-wrapper .overlay-icon {
            position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white;
            border-radius: 50%; padding: 8px; cursor: pointer;
            transition: background 0.3s ease;
        }
        .profile-image-upload-wrapper .overlay-icon:hover {
            background: rgba(0,0,0,0.8);
        }

        /* Day/Night Mode Specifics - Custom Variables & Tailwind Overrides */
        /* Light Theme */
        body {
            background-color: #f8fafc; /* Tailwind's gray-50 */
            color: #1f2937; /* Tailwind's gray-900 */
        }
        .sidebar { background-color: #1a202c; /* Tailwind's gray-900 */ }
        .sidebar .nav-item.bg-gray-700 { background-color: #4b5563 !important; } /* Active nav item */
        .header-bg { background-color: #ffffff; }
        .card-bg { background-color: #ffffff; }
        .text-default { color: #1f2937; }
        .text-secondary { color: #4b5563; }
        .border-default { border-color: #e5e7eb; }
        .hover-bg-light { background-color: #f3f4f6; } /* gray-100 */
        .btn-primary { background-color: #4f46e5; /* indigo-600 */ }
        .btn-primary:hover { background-color: #4338ca; /* indigo-700 */ }
        .btn-danger { background-color: #ef4444; /* red-500 */ }
        .btn-danger:hover { background-color: #dc2626; /* red-600 */ }
        .btn-warning { background-color: #f59e0b; /* yellow-500 */ }
        .btn-warning:hover { background-color: #d97706; /* yellow-600 */ }
        .btn-success { background-color: #22c55e; /* green-500 */ }
        .btn-success:hover { background-color: #16a34a; /* green-600 */ }


        /* Dark Theme */
        html.dark {
            --color-bg-body: #0f172a; /* Slate 950 */
            --color-bg-sidebar: #1e293b; /* Slate 900 */
            --color-bg-header: #1e293b; /* Slate 900 */
            --color-bg-card: #334155; /* Slate 800 */
            --color-text-default: #e2e8f0; /* Slate 200 */
            --color-text-secondary: #94a3b8; /* Slate 400 */
            --color-border: #475569; /* Slate 600 */
            --color-hover-bg: #475569; /* Slate 600 */
            --color-btn-primary: #0ea5e9; /* Sky 500 */
            --color-btn-primary-hover: #0284c7; /* Sky 600 */
            --color-btn-danger: #ef4444; /* Red 500 */
            --color-btn-danger-hover: #dc2626; /* Red 600 */
            --color-btn-warning: #fbbf24; /* Amber 400 */
            --color-btn-warning-hover: #fcd34d; /* Amber 300 */
            --color-btn-success: #22c55e; /* Green 500 */
            --color-btn-success-hover: #16a34a; /* Green 600 */
        }

        html.dark body {
            background-color: var(--color-bg-body);
            color: var(--color-text-default);
        }
        html.dark .sidebar { background-color: var(--color-bg-sidebar); }
        html.dark .sidebar .nav-item.bg-gray-700 { background-color: var(--color-hover-bg) !important; } /* Active nav item */
        html.dark .header-bg { background-color: var(--color-bg-header); }
        html.dark .card-bg { background-color: var(--color-bg-card); }
        html.dark .text-default { color: var(--color-text-default); }
        html.dark .text-secondary { color: var(--color-text-secondary); }
        html.dark .border-default { border-color: var(--color-border); }
        html.dark .hover-bg-light:hover { background-color: var(--color-hover-bg); }
        html.dark .btn-primary { background-color: var(--color-btn-primary); }
        html.dark .btn-primary:hover { background-color: var(--color-btn-primary-hover); }
        html.dark .btn-danger { background-color: var(--color-btn-danger); }
        html.dark .btn-danger:hover { background-color: var(--color-btn-danger-hover); }
        html.dark .btn-warning { background-color: var(--color-btn-warning); }
        html.dark .btn-warning:hover { background-color: var(--color-btn-warning-hover); }
        html.dark .btn-success { background-color: var(--color-btn-success); }
        html.dark .btn-success:hover { background-color: var(--color-btn-success-hover); }

        /* General input styling for both themes */
        input[type="text"], input[type="email"], input[type="password"], input[type="tel"],
        input[type="number"], input[type="date"], select, textarea {
            @apply shadow-sm appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 transition-all duration-200;
        }

        /* Light theme specific for inputs */
        html:not(.dark) input[type="text"],
        html:not(.dark) input[type="email"],
        html:not(.dark) input[type="password"],
        html:not(.dark) input[type="tel"],
        html:not(.dark) input[type="number"],
        html:not(.dark) input[type="date"],
        html:not(.dark) select,
        html:not(.dark) textarea {
            @apply bg-white text-gray-700 border-gray-300 focus:ring-blue-500 focus:border-transparent;
        }

        /* Dark theme specific for inputs */
        html.dark input[type="text"],
        html.dark input[type="email"],
        html.dark input[type="password"],
        html.dark input[type="tel"],
        html.dark input[type="number"],
        html.dark input[type="date"],
        html.dark select,
        html.dark textarea {
            background-color: var(--color-bg-card) !important;
            color: var(--color-text-default) !important;
            border-color: var(--color-border) !important;
            --tw-ring-color: var(--color-btn-primary) !important;
        }

        /* Adjust placeholder color for dark mode inputs */
        html.dark input::placeholder,
        html.dark textarea::placeholder {
            color: var(--color-text-secondary);
            opacity: 0.7;
        }

        /* Table specific styles */
        table {
            @apply w-full text-left;
        }
        th, td {
            @apply py-3 px-4;
        }
        thead {
            @apply bg-gray-800 text-white dark:bg-gray-900;
        }
        tbody tr {
            @apply border-b border-gray-200 dark:border-gray-700;
        }
        tbody tr:last-child {
            @apply border-b-0;
        }
        tbody tr:hover {
            @apply bg-gray-100 dark:bg-gray-700;
        }

    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="app" class="flex h-screen hidden">
        <aside id="sidebar" class="sidebar bg-gray-900 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 overflow-y-auto shadow-lg">
            <a href="#" class="text-white flex items-center space-x-2 px-4 border-b border-gray-700 pb-4">
                <i class="fas fa-school fa-2x text-yellow-400"></i>
                <span class="text-3xl font-extrabold">SMS</span>
            </a>
            <nav id="nav-menu" class="flex-1"></nav>
            <div class="px-4 py-2 border-t border-gray-700 pt-4">
                <button id="reset-data-btn" class="w-full btn-warning text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">Reset Data</button>
            </div>
        </aside>

        <div id="main-content" class="main-content flex-1 flex flex-col overflow-hidden">
            <header class="header-bg shadow-md p-4 flex justify-between items-center z-10">
                <button id="menu-button" class="text-gray-500 focus:outline-none md:hidden p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                <h1 id="page-title" class="text-2xl font-semibold text-default">Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <img id="header-user-avatar" src="https://via.placeholder.com/150/e0e0e0/000000?text=User" alt="User Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-indigo-300 dark:border-sky-500">
                    <span id="user-info" class="text-gray-600 dark:text-gray-300 hidden md:block font-medium"></span>
                    <button id="theme-toggle-btn" class="text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg p-2 transition duration-300">
                        <i id="theme-icon" class="fas fa-moon fa-lg"></i>
                    </button>
                    <button id="logout-button" class="btn-danger text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 shadow-md">Logout</button>
                </div>
            </header>
            <main id="content-area" class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 dark:bg-gray-900 p-6"></main>
        </div>
    </div>

    <div id="login-page" class="min-h-screen flex items-center justify-center">
        <div class="login-form-wrapper w-full max-w-sm">
            <div class="flex justify-center mb-6"><i class="fas fa-school fa-4x"></i></div>
            <h2 class="text-3xl font-bold text-center mb-6">School Management System</h2>
            <div id="login-error" class="hidden px-4 py-3 rounded relative mb-4" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="login-error-message"></span>
            </div>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-bold mb-2 text-left">Username / Email</label>
                    <input type="text" id="username" name="username" class="shadow-sm appearance-none border rounded w-full py-2 px-3 leading-tight focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-bold mb-2 text-left">Password</label>
                    <input type="password" id="password" name="password" class="shadow-sm appearance-none border rounded w-full py-2 px-3 mb-3 leading-tight focus:shadow-outline" required>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="btn-primary text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full transform hover:scale-105 shadow-md">Sign In</button>
                </div>
            </form>
            <p class="text-center text-xs mt-4">Hint: admin/admin, teacher's email/teacher, student's email/student</p>
        </div>
    </div>

    <div id="form-modal" class="modal"><div class="modal-content"><span id="close-modal-button" class="close-button">&times;</span><h2 id="modal-title" class="text-xl font-bold mb-4"></h2><div id="modal-body"></div></div></div>
    <div id="confirm-modal" class="confirm-modal"><div class="confirm-modal-content text-center"><h2 id="confirm-title" class="text-xl font-bold mb-4">Are you sure?</h2><p id="confirm-text" class="mb-6"></p><div class="flex justify-center space-x-4"><button id="confirm-yes-btn" class="btn-danger text-white font-bold py-2 px-4 rounded transform hover:scale-105 shadow-md">Yes, I'm sure</button><button id="confirm-no-btn" class="bg-gray-300 hover:bg-gray-400 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded transform hover:scale-105 shadow-md">Cancel</button></div></div></div>
    <div id="toast-container"></div>

    <script>
        // ===================================================================================
        // --- APP STATE & CONFIGURATION ---
        // ===================================================================================
        let currentUser = null;
        let appDatabase = {}; // This will be populated by the API service

        // Default profile image (a simple placeholder base64 string for demo)
        const DEFAULT_PROFILE_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJhIiB4MT0iMCIgeTI9IjEwMCIgZ3JhZGllbnRUcmFuc2Zvcm09InJvdGF0ZSgxMzUpIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPTiI+PHN0b3Agc3RvcC1jb2xvcj0iIzkzY2VlMiIgb2Zmc2V0PSIwIi8+PHN0b3Agc3RvcC1jb2xvcj0iIzY0OTVlZCIgb2Zmc2V0PSIxIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PGNpcmNsIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIgZmlsbD0idXJsKCNhKSIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik01MCA1OS41Yy05LjIgMC0xNi41IDYuNC0xNi41IDE0LjMgMCA3LjkgNy4zIDE0LjMgMTYuNSAxNC4zczE2LjUtNi40IDE2LjUtMTQuM2MwLTcuOS03LjMtMTQuMy0xNi41LTE0LjN6TTUwIDQ5Yy04LjggMC0xNi03LjItMTYtMTZzNy4yLTE2IDE2LTE2IDE2IDcuMiAxNiAxNnMtNy4yIDE2LTE2IDE2eiIvPjwvc3ZnPg==';

        // Initial hardcoded data, used only to seed localStorage for the demo
        const initialDatabase = {
            students: [
                { id: 's1', name: 'Alice Smith', rollNo: '2233081101', classId: 'c1', guardianName: 'John Smith', contact: '123-456-7890', email: 'alice@school.com', address: '123 Main St', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's2', name: 'Bob Johnson', rollNo: '223308102', classId: 'c1', guardianName: 'Jane Johnson', contact: '123-456-7891', email: 'bob@school.com', address: '456 Oak Ave', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's3', name: 'Charlie Brown', rollNo: '223308201', classId: 'c2', guardianName: 'Sally Brown', contact: '123-456-7892', email: 'charlie@school.com', address: '789 Pine Ln', profileImage: DEFAULT_PROFILE_IMAGE },
                // Added Students (30) from previous request
                { id: 's4', name: 'Diana Prince', rollNo: '223308103', classId: 'c1', guardianName: 'Hippolyta Prince', contact: '123-111-2223', email: 'diana@school.com', address: '1 Paradise Island', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's5', name: 'Bruce Wayne', rollNo: '223308104', classId: 'c1', guardianName: 'Alfred Pennyworth', contact: '123-222-3334', email: 'bruce@school.com', address: '1007 Mountain Drive', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's6', name: 'Clark Kent', rollNo: '223308105', classId: 'c1', guardianName: 'Martha Kent', contact: '123-333-4445', email: 'clark@school.com', address: '321 Farm Road', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's7', name: 'Peter Parker', rollNo: '223308106', classId: 'c1', guardianName: 'May Parker', contact: '123-444-5556', email: 'peter@school.com', address: '20 Ingram Street', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's8', name: 'Tony Stark', rollNo: '223308107', classId: 'c1', guardianName: 'Howard Stark', contact: '123-555-6667', email: 'tony@school.com', address: '10880 Malibu Point', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's9', name: 'Steve Rogers', rollNo: '223308108', classId: 'c1', guardianName: 'Sarah Rogers', contact: '123-666-7778', email: 'steve@school.com', address: '569 Leavenworth St', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's10', name: 'Natasha Romanoff', rollNo: '223308109', classId: 'c1', guardianName: 'Ivan Romanoff', contact: '123-777-8889', email: 'natasha@school.com', address: 'Stalingrad, Russia', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's11', name: 'Wanda Maximoff', rollNo: '223308110', classId: 'c1', guardianName: 'Olek Maximoff', contact: '123-888-9990', email: 'wanda@school.com', address: 'Novi Grad, Sokovia', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's12', name: 'TChalla Udaku', rollNo: '223308111', classId: 'c1', guardianName: 'Ramonda Udaku', contact: '123-999-0001', email: 'tchalla@school.com', address: 'Royal Palace, Wakanda', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's13', name: 'Carol Danvers', rollNo: '223308112', classId: 'c1', guardianName: 'Marie Danvers', contact: '123-000-1112', email: 'carol@school.com', address: 'Planet Hala', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's14', name: 'David Banner', rollNo: '223308202', classId: 'c2', guardianName: 'Brian Banner', contact: '213-111-2223', email: 'david@school.com', address: 'Unknown', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's15', name: 'Thor Odinson', rollNo: '223308203', classId: 'c2', guardianName: 'Odin Borson', contact: '213-222-3334', email: 'thor@school.com', address: 'Asgard', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's16', name: 'Loki Laufeyson', rollNo: '223308204', classId: 'c2', guardianName: 'Farbauti Laufeyson', contact: '213-333-4445', email: 'loki@school.com', address: 'Jotunheim', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's17', name: 'Jane Foster', rollNo: '223308205', classId: 'c2', guardianName: 'Erik Selvig', contact: '213-444-5556', email: 'jane@school.com', address: 'Puente Antiguo, NM', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's18', name: 'Bucky Barnes', rollNo: '223308206', classId: 'c2', guardianName: 'George Barnes', contact: '213-555-6667', email: 'bucky@school.com', address: 'Shelbyville, IN', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's19', name: 'Sam Wilson', rollNo: '223308207', classId: 'c2', guardianName: 'Paul Wilson', contact: '213-666-7778', email: 'sam@school.com', address: 'Harlem, NY', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's20', name: 'Scott Lang', rollNo: '223308208', classId: 'c2', guardianName: 'Maggie Lang', contact: '213-777-8889', email: 'scott@school.com', address: 'San Francisco, CA', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's21', name: 'Hope van Dyne', rollNo: '223308209', classId: 'c2', guardianName: 'Hank Pym', contact: '213-888-9990', email: 'hope@school.com', address: 'San Francisco, CA', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's22', name: 'Stephen Strange', rollNo: '223308210', classId: 'c2', guardianName: 'Eugene Strange', contact: '213-999-0001', email: 'stephen@school.com', address: '177A Bleecker Street', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's23', name: 'Matt Murdock', rollNo: '223308301', classId: 'c3', guardianName: 'Jack Murdock', contact: '312-111-2223', email: 'matt@school.com', address: 'Hells Kitchen, NY', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's24', name: 'Jessica Jones', rollNo: '223308302', classId: 'c3', guardianName: 'Alisa Jones', contact: '312-222-3334', email: 'jessica@school.com', address: 'Forest Hills, Queens', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's25', name: 'Luke Cage', rollNo: '223308303', classId: 'c3', guardianName: 'James Lucas', contact: '312-333-4445', email: 'luke@school.com', address: 'Harlem, NY', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's26', name: 'Danny Rand', rollNo: '223308304', classId: 'c3', guardianName: 'Wendell Rand', contact: '312-444-5556', email: 'danny@school.com', address: 'K\'un-Lun', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's27', name: 'Frank Castle', rollNo: '223308305', classId: 'c3', guardianName: 'Maria Castle', contact: '312-555-6667', email: 'frank@school.com', address: 'Queens, NY', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's28', name: 'Elektra Natchios', rollNo: '223308306', classId: 'c3', guardianName: 'Hugo Natchios', contact: '312-666-7778', email: 'elektra@school.com', address: 'Greek Islands', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's29', name: 'Reed Richards', rollNo: '223308307', classId: 'c3', guardianName: 'Nathaniel Richards', contact: '312-777-8889', email: 'reed@school.com', address: 'Central City, CA', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's30', name: 'Sue Storm', rollNo: '223308308', classId: 'c3', guardianName: 'Franklin Storm', contact: '312-888-9990', email: 'sue@school.com', address: 'Long Island, NY', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's31', name: 'Johnny Storm', rollNo: '223308309', classId: 'c3', guardianName: 'Franklin Storm', contact: '312-999-0001', email: 'johnny@school.com', address: 'Long Island, NY', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's32', name: 'Ben Grimm', rollNo: '223308310', classId: 'c3', guardianName: 'Daniel Grimm', contact: '312-000-1112', email: 'ben@school.com', address: 'Yancy Street, NY', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's33', name: 'Ororo Munroe', rollNo: '223308311', classId: 'c3', guardianName: 'N\'Dare Munroe', contact: '312-111-2222', email: 'ororo@school.com', address: 'Cairo, Egypt', profileImage: DEFAULT_PROFILE_IMAGE },
                 // Students from CSV
                { id: 's_2233081040', name: 'Mst Tasnim Amina Tanha', rollNo: '2233081040', classId: 'c4', guardianName: 'Amina Tanha', contact: '555-0101', email: 'tasnim.tanha@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081244', name: 'Ratul Hasan', rollNo: '2233081244', classId: 'c4', guardianName: 'Kabir Hasan', contact: '555-0102', email: 'ratul.hasan@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081263', name: 'Jubayer Ahmed Ratul', rollNo: '2233081263', classId: 'c4', guardianName: 'Farid Ahmed', contact: '555-0103', email: 'jubayer.ratul@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081267', name: 'Jamil Sarkar Hamim', rollNo: '2233081267', classId: 'c4', guardianName: 'Ali Sarkar', contact: '555-0104', email: 'jamil.hamim@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081311', name: 'Arindom Chakrabarty Turjo', rollNo: '2233081311', classId: 'c4', guardianName: 'G. Chakrabarty', contact: '555-0105', email: 'arindom.turjo@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081251', name: 'Monayem Hossain', rollNo: '2233081251', classId: 'c4', guardianName: 'Nur Hossain', contact: '555-0106', email: 'monayem.hossain@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081204', name: 'Prottoy Mankin', rollNo: '2233081204', classId: 'c4', guardianName: 'David Mankin', contact: '555-0107', email: 'prottoy.mankin@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081205', name: 'MD Jubayer hossain manik', rollNo: '2233081205', classId: 'c4', guardianName: 'Alam Hossain', contact: '555-0108', email: 'jubayer.manik@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081223', name: 'Tahmidul Islam Afrose', rollNo: '2233081223', classId: 'c4', guardianName: 'Rafiqul Islam', contact: '555-0109', email: 'tahmidul.afrose@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081222', name: 'Tahsinul Islam Imrose', rollNo: '2233081222', classId: 'c4', guardianName: 'Rafiqul Islam', contact: '555-0110', email: 'tahsinul.imrose@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081237', name: 'Junidur Rahman', rollNo: '2233081237', classId: 'c4', guardianName: 'Habibur Rahman', contact: '555-0111', email: 'junidur.rahman@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081255', name: 'Mamun Shake', rollNo: '2233081255', classId: 'c4', guardianName: 'Abdullah Shake', contact: '555-0112', email: 'mamun.shake@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081266', name: 'Raian Mahadi', rollNo: '2233081266', classId: 'c4', guardianName: 'Fahim Mahadi', contact: '555-0113', email: 'raian.mahadi@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081220', name: 'Md Saiful Islam', rollNo: '2233081220', classId: 'c4', guardianName: 'Sirajul Islam', contact: '555-0114', email: 'saiful.islam@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081228', name: 'Shourav Beswas', rollNo: '2233081228', classId: 'c4', guardianName: 'B. Beswas', contact: '555-0115', email: 'shourav.beswas@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081271', name: 'Meherub Hassan Badhon', rollNo: '2233081271', classId: 'c4', guardianName: 'Anwar Hassan', contact: '555-0116', email: 'meherub.badhon@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081550', name: 'Kanej Fatema Keya', rollNo: '2233081550', classId: 'c5', guardianName: 'Abul Fatema', contact: '555-0117', email: 'kanej.keya@school.com', address: 'Chittagong, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081556', name: 'Anika Ebnat', rollNo: '2233081556', classId: 'c5', guardianName: 'Jamal Ebnat', contact: '555-0118', email: 'anika.ebnat@school.com', address: 'Chittagong, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081569', name: 'Farjana Bushra', rollNo: '2233081569', classId: 'c5', guardianName: 'Kamal Bushra', contact: '555-0119', email: 'farjana.bushra@school.com', address: 'Chittagong, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081531', name: 'Most. Khushi Akter', rollNo: '2233081531', classId: 'c4', guardianName: 'Rahim Akter', contact: '555-0120', email: 'khushi.akter@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081545', name: 'Sanzida Sultana', rollNo: '2233081545', classId: 'c4', guardianName: 'Karim Sultana', contact: '555-0121', email: 'sanzida.sultana@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081582', name: 'Sanjida Akter Ruma', rollNo: '2233081582', classId: 'c4', guardianName: 'Salim Akter', contact: '555-0122', email: 'sanjida.ruma@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081053', name: 'Jannatul Mawya', rollNo: '2233081053', classId: 'c4', guardianName: 'Ferdous Mawya', contact: '555-0123', email: 'jannatul.mawya@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081272', name: 'Md.Zonaed Hossain', rollNo: '2233081272', classId: 'c4', guardianName: 'Bilal Hossain', contact: '555-0124', email: 'zonaed.hossain@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081265', name: 'Md.Rokib hasan noyon', rollNo: '2233081265', classId: 'c4', guardianName: 'Jamal Hasan', contact: '555-0125', email: 'rokib.noyon@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081260', name: 'Md Abrar Projoy', rollNo: '2233081260', classId: 'c4', guardianName: 'Dalim Projoy', contact: '555-0126', email: 'abrar.projoy@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081268', name: 'Tuton Ghosh', rollNo: '2233081268', classId: 'c4', guardianName: 'T. Ghosh', contact: '555-0127', email: 'tuton.ghosh@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081269', name: 'Mohammad Hosen', rollNo: '2233081269', classId: 'c4', guardianName: 'Abdul Hosen', contact: '555-0128', email: 'mohammad.hosen@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2231081042', name: 'Israt jahan shimu', rollNo: '2231081042', classId: 'c4', guardianName: 'Iqbal Jahan', contact: '555-0129', email: 'israt.shimu@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081246', name: 'Md Junaid', rollNo: '2233081246', classId: 'c4', guardianName: 'Yusuf Junaid', contact: '555-0130', email: 'md.junaid@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 's_2233081257', name: 'Md. Samiuzzaman', rollNo: '2233081257', classId: 'c4', guardianName: 'S. Zaman', contact: '555-0131', email: 'md.samiuzzaman@school.com', address: 'Dhaka, BD', profileImage: DEFAULT_PROFILE_IMAGE },
            ],
            teachers: [
                { id: 't1', name: 'Mr. Davis', subject: 'Math', contact: '987-654-3210', email: 'davis@school.com', address: '222 Teacher Rd', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't2', name: 'Ms. Wilson', subject: 'Science', contact: '987-654-3211', email: 'wilson@school.com', address: '333 Faculty Ct', profileImage: DEFAULT_PROFILE_IMAGE },
                // Added Teachers (20) from previous request
                { id: 't3', name: 'Mr. Anderson', subject: 'History', contact: '987-111-2223', email: 'anderson@school.com', address: '444 History Ln', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't4', name: 'Ms. Garcia', subject: 'English', contact: '987-222-3334', email: 'garcia@school.com', address: '555 Literature Ave', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't5', name: 'Mr. Martinez', subject: 'Physical Education', contact: '987-333-4445', email: 'martinez@school.com', address: '666 Gymnasium Blvd', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't6', name: 'Ms. Lee', subject: 'Art', contact: '987-444-5556', email: 'lee@school.com', address: '777 Creativity Cres', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't7', name: 'Mr. Chen', subject: 'Music', contact: '987-555-6667', email: 'chen@school.com', address: '888 Harmony Way', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't8', name: 'Ms. Taylor', subject: 'Biology', contact: '987-666-7778', email: 'taylor@school.com', address: '999 Cell Division Dr', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't9', name: 'Mr. Moore', subject: 'Chemistry', contact: '987-777-8889', email: 'moore@school.com', address: '101 Element St', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't10', name: 'Ms. Clark', subject: 'Physics', contact: '987-888-9990', email: 'clark@school.com', address: '202 Quantum Quay', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't11', name: 'Mr. Wright', subject: 'Geography', contact: '987-999-0001', email: 'wright@school.com', address: '303 Atlas Alley', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't12', name: 'Ms. Evans', subject: 'Computer Science', contact: '987-000-1112', email: 'evans@school.com', address: '404 Binary Bypass', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't13', name: 'Mr. Harris', subject: 'Economics', contact: '987-112-2233', email: 'harris@school.com', address: '505 Market Mews', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't14', name: 'Ms. Lewis', subject: 'Social Studies', contact: '987-223-3344', email: 'lewis@school.com', address: '606 Society Sq', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't15', name: 'Mr. Walker', subject: 'Drama', contact: '987-334-4455', email: 'walker@school.com', address: '707 Stage Street', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't16', name: 'Ms. Hall', subject: 'French', contact: '987-445-5566', email: 'hall@school.com', address: '808 Paris Place', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't17', name: 'Mr. Allen', subject: 'Spanish', contact: '987-556-6677', email: 'allen@school.com', address: '909 Madrid Manor', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't18', name: 'Ms. King', subject: 'German', contact: '987-667-7788', email: 'king@school.com', address: '121 Berlin Blvd', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't19', name: 'Mr. Scott', subject: 'Philosophy', contact: '987-778-8899', email: 'scott@school.com', address: '232 Thought Thicket', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't20', name: 'Ms. Green', subject: 'Environmental Sci.', contact: '987-889-9900', email: 'green@school.com', address: '343 Ecology Esplanade', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't21', name: 'Mr. Baker', subject: 'Algebra', contact: '987-990-0011', email: 'baker@school.com', address: '454 Equation End', profileImage: DEFAULT_PROFILE_IMAGE },
                { id: 't22', name: 'Ms. Adams', subject: 'Literature', contact: '987-001-1122', email: 'adams@school.com', address: '565 Novella Nook', profileImage: DEFAULT_PROFILE_IMAGE },
            ],
            notices: [
                { id: 'n1', title: 'School Reopens', content: 'The school will reopen on Monday, August 4th, 2025.', date: '2025-07-25', target: 'All', senderId: 'admin', senderRole: 'Admin' },
                { id: 'n2', title: 'Annual Sports Day', content: 'The annual sports day will be held in the last week of September.', date: '2025-07-20', target: 'All', senderId: 'admin', senderRole: 'Admin' },
                { id: 'n3', title: 'Teacher Meeting', content: 'All teachers are requested to attend a meeting on Friday at 3 PM in the staff room.', date: '2025-07-26', target: 'Teacher', senderId: 'admin', senderRole: 'Admin' },
                { id: 'n4', title: 'Science Fair Submissions', content: 'Students interested in the science fair must submit their project proposals by the end of this month.', date: '2025-07-24', target: 'Student', senderId: 'admin', senderRole: 'Admin' },
                { id: 'n5', title: 'Fee Payment Reminder', content: 'The last date for fee payment for the current term is August 10th. Please pay on time to avoid a late fee.', date: '2025-07-22', target: 'All', senderId: 'admin', senderRole: 'Admin' }
            ],
            subjects: [{ id: 'sub1', name: 'Mathematics', code: 'MATH101' }, { id: 'sub2', name: 'Science', code: 'SCI101' }, { id: 'sub3', name: 'History', code: 'HIST101' }],
            classes: [
                { id: 'c1', name: 'Class 1', teacherId: 't2' },
                { id: 'c2', name: 'Class 2', teacherId: 't1' },
                { id: 'c3', name: 'Class 3', teacherId: 't3' },
                // Classes for CSV data
                { id: 'c4', name: 'Section G', teacherId: 't4' },
                { id: 'c5', name: 'Section C', teacherId: 't5' }
            ],
            exams: [{ id: 'ex1', name: 'Mid-Term Exam', classId: 'c1', subjectId: 'sub2', date: '2025-09-15', maxMarks: 100 }],
            results: [{ resultId: 'res1', examId: 'ex1', studentId: 's1', marks: 85 }, { resultId: 'res2', examId: 'ex1', studentId: 's2', marks: 78 }],
            attendance: { '2025-07-26_c1': { date: '2025-07-26', classId: 'c1', records: { 's1': 'Present', 's2': 'Absent' } } },
            fees: [
                { id: 'f1', studentId: 's1', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f2', studentId: 's2', amount: 5000, dueDate: '2025-08-10', status: 'Unpaid' },
                // Fees for CSV students
                { id: 'f_2233081040', studentId: 's_2233081040', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081244', studentId: 's_2233081244', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081263', studentId: 's_2233081263', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081267', studentId: 's_2233081267', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081311', studentId: 's_2233081311', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081251', studentId: 's_2233081251', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081204', studentId: 's_2233081204', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081205', studentId: 's_2233081205', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081223', studentId: 's_2233081223', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081222', studentId: 's_2233081222', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081237', studentId: 's_2233081237', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081255', studentId: 's_2233081255', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081266', studentId: 's_2233081266', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081220', studentId: 's_2233081220', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081228', studentId: 's_2233081228', amount: 5000, dueDate: '2025-08-10', status: 'Unpaid' },
                { id: 'f_2233081271', studentId: 's_2233081271', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081550', studentId: 's_2233081550', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081556', studentId: 's_2233081556', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081569', studentId: 's_2233081569', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081531', studentId: 's_2233081531', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081545', studentId: 's_2233081545', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081582', studentId: 's_2233081582', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081053', studentId: 's_2233081053', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081272', studentId: 's_2233081272', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081265', studentId: 's_2233081265', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081260', studentId: 's_2233081260', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081268', studentId: 's_2233081268', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081269', studentId: 's_2233081269', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2231081042', studentId: 's_2231081042', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081246', studentId: 's_2233081246', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
                { id: 'f_2233081257', studentId: 's_2233081257', amount: 5000, dueDate: '2025-08-10', status: 'Paid' },
            ],
        };

        const mockUsers = {
            'admin': { id: 'admin', password: 'admin', role: 'Admin', name: 'Admin User', email: 'admin@school.com', profileImage: 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png' }
        };

        const navConfig = {
            Admin: [
                { icon: 'fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                { icon: 'fa-user-graduate', text: 'Students', page: 'students' },
                { icon: 'fa-chalkboard-teacher', text: 'Teachers', page: 'teachers' },
                { icon: 'fa-school', text: 'Classes', page: 'classes' },
                { icon: 'fa-calendar-alt', text: 'Attendance', page: 'attendance' },
                { icon: 'fa-file-invoice-dollar', text: 'Fees', page: 'fees' },
                { icon: 'fa-file-alt', text: 'Exams', page: 'exams' },
                { icon: 'fa-bullhorn', text: 'Notice Board', page: 'notices' },
                { icon: 'fa-user-circle', text: 'Profile', page: 'profile' },
            ],
            Teacher: [
                { icon: 'fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                { icon: 'fa-user-graduate', text: 'My Students', page: 'students' }, // Teacher can only see their students
                { icon: 'fa-calendar-alt', text: 'Attendance', page: 'attendance' },
                { icon: 'fa-file-alt', text: 'Exams & Results', page: 'exams' },
                { icon: 'fa-bullhorn', text: 'Notice Board', page: 'notices' },
                { icon: 'fa-paper-plane', text: 'Message Students', page: 'messageStudents' }, // New message students option
                { icon: 'fa-user-circle', text: 'Profile', page: 'profile' },
            ],
            Student: [
                { icon: 'fa-tachometer-alt', text: 'Dashboard', page: 'dashboard' },
                { icon: 'fa-file-invoice-dollar', text: 'My Fees', page: 'fees' },
                { icon: 'fa-file-alt', text: 'My Results', page: 'exams' },
                { icon: 'fa-bullhorn', text: 'Notice Board', page: 'notices' },
                { icon: 'fa-envelope', text: 'Contact Teacher', page: 'contactTeacher' }, // New contact teacher option
                { icon: 'fa-user-circle', text: 'Profile', page: 'profile' },
            ]
        };

        // ===================================================================================
        // --- SIMULATED API SERVICE --- (This section can be replaced with real API calls)
        // ===================================================================================
        const apiService = (() => {
            const DB_KEY = 'sms_database_advanced';

            const init = () => {
                const savedDb = localStorage.getItem(DB_KEY);
                // Deep copy initialDatabase to avoid modifying the original when seeding
                appDatabase = savedDb ? JSON.parse(savedDb) : JSON.parse(JSON.stringify(initialDatabase));

                // Ensure all users have a profileImage
                ['students', 'teachers'].forEach(collection => {
                    appDatabase[collection] = appDatabase[collection].map(item => ({
                        ...item,
                        profileImage: item.profileImage || DEFAULT_PROFILE_IMAGE
                    }));
                });
                for (const userKey in mockUsers) {
                    mockUsers[userKey].profileImage = mockUsers[userKey].profileImage || DEFAULT_PROFILE_IMAGE;
                }

                save();
            };

            const save = () => localStorage.setItem(DB_KEY, JSON.stringify(appDatabase));

            const reset = () => {
                localStorage.removeItem(DB_KEY);
                init();
            };

            // Generic CRUD methods
            const get = (collection) => new Promise(resolve => setTimeout(() => resolve(appDatabase[collection] || []), 100));
            const create = (collection, data) => new Promise(resolve => setTimeout(() => {
                const newItem = { ...data, id: `${collection.slice(0, 1)}${Date.now()}` };
                appDatabase[collection].push(newItem);
                save();
                resolve(newItem);
            }, 100));
            const update = (collection, id, data) => new Promise(resolve => setTimeout(() => {
                const index = appDatabase[collection].findIndex(item => item.id === id);
                if (index !== -1) {
                    appDatabase[collection][index] = { ...appDatabase[collection][index], ...data };
                    save();
                    resolve(appDatabase[collection][index]);
                }
            }, 100));
            const remove = (collection, id) => new Promise(resolve => setTimeout(() => {
                appDatabase[collection] = appDatabase[collection].filter(item => item.id !== id);
                save();
                resolve({ success: true });
            }, 100));

            // Special methods
            const getAttendance = (date, classId) => new Promise(resolve => {
                 const key = `${date}_${classId}`;
                 resolve(appDatabase.attendance[key] || null);
            });
            const saveAttendance = (date, classId, records) => new Promise(resolve => {
                const key = `${date}_${classId}`;
                appDatabase.attendance[key] = { date, classId, records };
                save();
                resolve(appDatabase.attendance[key]);
            });
            const getResultsForExam = (examId) => new Promise(resolve => {
                const results = appDatabase.results.filter(r => r.examId === examId);
                resolve(results);
            });
            const saveResults = (examId, resultsData) => new Promise(resolve => {
                // Remove old results for this exam first
                appDatabase.results = appDatabase.results.filter(r => r.examId !== examId);
                // Add new/updated results
                resultsData.forEach(res => {
                    appDatabase.results.push({ resultId: `res${Date.now()}${res.studentId}`, examId, ...res });
                });
                save();
                resolve({ success: true });
            });

            init(); // Load database on script start

            return { init, reset, get, create, update, remove, getAttendance, saveAttendance, getResultsForExam, saveResults };
        })();

        // ===================================================================================
        // --- UI Elements & Event Listeners ---
        // ===================================================================================
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginErrorMessage = document.getElementById('login-error-message');
        const logoutButton = document.getElementById('logout-button');
        const contentArea = document.getElementById('content-area');
        const pageTitle = document.getElementById('page-title');
        const navMenu = document.getElementById('nav-menu');
        const userInfo = document.getElementById('user-info');
        const headerUserAvatar = document.getElementById('header-user-avatar');
        const menuButton = document.getElementById('menu-button');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const modal = document.getElementById('form-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        const resetDataBtn = document.getElementById('reset-data-btn');
        const toastContainer = document.getElementById('toast-container');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon');


        // ===================================================================================
        // --- CORE APP LOGIC (AUTH, NAVIGATION, UI, THEME) ---
        // ===================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            setupTheme();
            handleAuth();

            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            resetDataBtn.addEventListener('click', () => {
                showConfirmationModal('This will delete all changes and restore original data. Are you sure?', () => {
                    apiService.reset();
                    showToast('Data has been reset.', 'success');
                    const activePage = document.querySelector('.nav-item.bg-gray-700')?.dataset.page || 'dashboard';
                    navigateTo(activePage);
                });
            });
            // Toggle sidebar on small screens
            menuButton.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));
            themeToggleBtn.addEventListener('click', toggleTheme);

            // Modal closing logic
            closeModalButton.onclick = closeModal;
            confirmNoBtn.onclick = closeConfirmationModal;
            window.onclick = (event) => {
                if (event.target == modal) closeModal();
                if (event.target == confirmModal) closeConfirmationModal();
            };
        });

        /**
         * Sets up the initial theme based on localStorage or system preference.
         */
        function setupTheme() {
            const isDarkMode = localStorage.getItem('theme') === 'dark' ||
                               (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                themeIcon.classList.replace('fa-moon', 'fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
                themeIcon.classList.replace('fa-sun', 'fa-moon');
            }
        }

        /**
         * Toggles between light and dark themes.
         */
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                themeIcon.classList.replace('fa-sun', 'fa-moon');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                themeIcon.classList.replace('fa-moon', 'fa-sun');
            }
        }

        /**
         * Handles user authentication by checking session storage.
         */
        function handleAuth() {
            const storedUser = sessionStorage.getItem('sms_user');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showApp();
            } else {
                showLogin();
            }
        }

        /**
         * Handles the login form submission.
         * @param {Event} e - The submit event.
         */
        async function handleLogin(e) {
            e.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            let userRecord = null;
            let role = '';

            // Check mock admin users
            if (mockUsers[username] && mockUsers[username].password === password) {
                userRecord = mockUsers[username];
                role = mockUsers[username].role;
            } else {
                // Check teachers
                const teachers = await apiService.get('teachers');
                const teacher = teachers.find(t => t.email === username);
                if (teacher && password === 'teacher') {
                    userRecord = teacher;
                    role = 'Teacher';
                } else {
                    // Check students
                    const students = await apiService.get('students');
                    const student = students.find(s => s.email === username);
                    if (student && password === 'student') {
                        userRecord = student;
                        role = 'Student';
                    }
                }
            }

            if (userRecord) {
                currentUser = { ...userRecord, role };
                sessionStorage.setItem('sms_user', JSON.stringify(currentUser));
                showApp();
            } else {
                loginErrorMessage.textContent = 'Invalid username or password.';
                loginError.style.display = 'block';
            }
        }

        /**
         * Handles user logout.
         */
        function handleLogout() {
            currentUser = null;
            sessionStorage.removeItem('sms_user');
            showLogin();
        }

        // --- UI Helpers & Switching ---
        /**
         * Shows the login page and hides the main application.
         */
        function showLogin() {
            loginPage.classList.remove('hidden');
            appContainer.classList.add('hidden');
            loginForm.reset(); // Clear form on logout
            loginError.style.display = 'none'; // Hide error message
        }

        /**
         * Shows the main application and hides the login page.
         */
        function showApp() {
            loginPage.classList.add('hidden');
            appContainer.classList.remove('hidden');
            setupUIForRole();
            navigateTo('dashboard');
        }

        /**
         * Sets up the navigation menu and user info based on the current user's role.
         */
        function setupUIForRole() {
            if (!currentUser) return;
            userInfo.textContent = `Welcome, ${currentUser.name} (${currentUser.role})`;
            headerUserAvatar.src = currentUser.profileImage || DEFAULT_PROFILE_IMAGE;

            const menuItems = navConfig[currentUser.role];
            navMenu.innerHTML = menuItems.map(item => `
                <a href="#" class="nav-item flex items-center space-x-3 text-gray-300 hover:bg-gray-700 hover:text-white px-4 py-2 rounded-md transition duration-200" data-page="${item.page}">
                    <i class="fas ${item.icon} w-6 text-center"></i>
                    <span>${item.text}</span>
                </a>
            `).join('');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('bg-gray-700', 'text-white'));
                    item.classList.add('bg-gray-700', 'text-white');
                    navigateTo(item.dataset.page);
                    if (window.innerWidth < 768) sidebar.classList.add('-translate-x-full'); // Hide sidebar on mobile after navigation
                });
            });
            // Set dashboard as active by default
            document.querySelector('.nav-item[data-page="dashboard"]')?.classList.add('bg-gray-700', 'text-white');
        }

        /**
         * Navigates to a specified page and renders its content.
         * @param {string} page - The page identifier.
         */
        function navigateTo(page) {
            const pageText = navConfig[currentUser.role].find(item => item.page === page)?.text || 'Page';
            pageTitle.textContent = pageText;
            contentArea.innerHTML = `<div class="flex justify-center items-center h-full min-h-[200px]"><i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i></div>`; // Loading spinner

            const pageRenderers = {
                'dashboard': renderDashboard,
                'students': renderStudentsPage,
                'teachers': renderTeachersPage,
                'classes': renderClassesPage,
                'attendance': renderAttendancePage,
                'fees': renderFeesPage,
                'exams': renderExamsPage,
                'notices': renderNoticesPage,
                'profile': renderProfilePage,
                'messageStudents': renderMessageStudentsPage, // New page for teachers
                'contactTeacher': renderContactTeacherPage,   // New page for students
            };

            const renderFunc = pageRenderers[page] || (() => { contentArea.innerHTML = '<p class="text-center py-10 text-default">Page not found.</p>'; });
            renderFunc();
        }

        // ===================================================================================
        // --- PAGE RENDERERS ---
        // ===================================================================================

        /**
         * Renders the dashboard page based on user role.
         */
        async function renderDashboard() {
            const students = await apiService.get('students');
            const teachers = await apiService.get('teachers');
            const fees = await apiService.get('fees');
            const allNotices = await apiService.get('notices');

            // Filter notices for the dashboard based on user role
            const notices = allNotices.filter(n =>
                n.target === 'All' || n.target === currentUser.role || (n.target === currentUser.id && currentUser.role === 'Student') || (n.target === currentUser.id && currentUser.role === 'Teacher')
            ).sort((a, b) => new Date(b.date) - new Date(a.date));

            const studentCount = students.length;
            const teacherCount = teachers.length;
            const unpaidFees = fees.filter(f => f.status === 'Unpaid').length;

            let dashboardStatsHtml = ``;

            if (currentUser.role === 'Admin') {
                dashboardStatsHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="card-bg p-6 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200"><div><p class="text-secondary">Total Students</p><p class="text-3xl font-bold text-default">${studentCount}</p></div><i class="fas fa-user-graduate fa-3x text-indigo-500"></i></div>
                        <div class="card-bg p-6 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200"><div><p class="text-secondary">Total Teachers</p><p class="text-3xl font-bold text-default">${teacherCount}</p></div><i class="fas fa-chalkboard-teacher fa-3x text-green-500"></i></div>
                        <div class="card-bg p-6 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200"><div><p class="text-secondary">Fees Due</p><p class="text-3xl font-bold text-default">${unpaidFees}</p></div><i class="fas fa-file-invoice-dollar fa-3x text-amber-500"></i></div>
                        <div class="card-bg p-6 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200"><div><p class="text-secondary">Total Notices</p><p class="text-3xl font-bold text-default">${notices.length}</p></div><i class="fas fa-bullhorn fa-3x text-purple-500"></i></div>
                    </div>`;
            } else if (currentUser.role === 'Teacher') {
                const myClasses = (await apiService.get('classes')).filter(c => c.teacherId === currentUser.id);
                const myStudentsCount = students.filter(s => myClasses.map(c => c.id).includes(s.classId)).length;
                dashboardStatsHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="card-bg p-6 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200"><div><p class="text-secondary">My Classes</p><p class="text-3xl font-bold text-default">${myClasses.length}</p></div><i class="fas fa-school fa-3x text-indigo-500"></i></div>
                        <div class="card-bg p-6 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200"><div><p class="text-secondary">My Students</p><p class="text-3xl font-bold text-default">${myStudentsCount}</p></div><i class="fas fa-user-graduate fa-3x text-green-500"></i></div>
                        <div class="card-bg p-6 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200"><div><p class="text-secondary">Relevant Notices</p><p class="text-3xl font-bold text-default">${notices.length}</p></div><i class="fas fa-bullhorn fa-3x text-purple-500"></i></div>
                    </div>`;
            } else if (currentUser.role === 'Student') {
                const myFees = fees.filter(f => f.studentId === currentUser.id);
                const myUnpaidFees = myFees.filter(f => f.status === 'Unpaid').length;
                const myResults = (await apiService.get('results')).filter(r => r.studentId === currentUser.id);
                const myExams = (await apiService.get('exams')).filter(e => e.classId === currentUser.classId);

                dashboardStatsHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <div class="card-bg p-6 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200"><div><p class="text-secondary">Unpaid Fees</p><p class="text-3xl font-bold text-default">${myUnpaidFees}</p></div><i class="fas fa-file-invoice-dollar fa-3x text-amber-500"></i></div>
                        <div class="card-bg p-6 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200"><div><p class="text-secondary">Exams Taken</p><p class="text-3xl font-bold text-default">${myResults.length} / ${myExams.length}</p></div><i class="fas fa-file-alt fa-3x text-sky-500"></i></div>
                        <div class="card-bg p-6 rounded-lg shadow-md flex items-center justify-between transform hover:scale-105 transition-transform duration-200"><div><p class="text-secondary">Relevant Notices</p><p class="text-3xl font-bold text-default">${notices.length}</p></div><i class="fas fa-bullhorn fa-3x text-purple-500"></i></div>
                    </div>`;
            }


            contentArea.innerHTML = `
                ${dashboardStatsHtml}
                <div class="card-bg p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2 border-default">Recent Notices</h3>
                    <div id="dashboard-notices">
                        ${notices.length > 0 ? notices.slice(0, 5).map(n => `
                            <div class="border-b border-default py-3 last:border-b-0">
                                <p class="font-bold text-lg text-default">${n.title}
                                    <span class="text-sm font-normal text-secondary">(${n.date})</span>
                                    ${n.senderRole && n.senderRole !== 'Admin' ? `<span class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100">${n.senderRole} Message</span>` : ''}
                                </p>
                                <p class="text-base text-default">${n.content}</p>
                            </div>`).join('') : '<p class="text-secondary">No recent notices.</p>'}
                    </div>
                </div>`;
        }

        /**
         * Renders the Students page. Role-based filtering is applied.
         */
        async function renderStudentsPage() {
            const classes = await apiService.get('classes');

            let studentDataFilter = null;
            if (currentUser.role === 'Teacher') {
                const teacherClasses = classes.filter(c => c.teacherId === currentUser.id).map(c => c.id);
                studentDataFilter = (student) => teacherClasses.includes(student.classId);
            }

            contentArea.innerHTML = `
                <div class="card-bg p-6 rounded-lg shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <div class="flex flex-col md:flex-row items-center space-y-2 md:space-y-0 md:space-x-4 w-full md:w-auto">
                            <input type="text" id="search-input" placeholder="Search by name or email..." class="w-full md:w-auto">
                            <select id="class-filter" class="w-full md:w-auto"><option value="">All Classes</option>${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select>
                        </div>
                        ${currentUser.role === 'Admin' ? `<button id="add-new-btn" class="btn-primary text-white font-bold py-2 px-4 rounded w-full md:w-auto transform hover:scale-105 transition-transform duration-200 shadow-md">Add Student</button>` : ''}
                    </div>
                    <div class="overflow-x-auto"><table class="table-auto min-w-full rounded-lg overflow-hidden"><thead><tr>
                        <th class="py-3 px-4 uppercase font-semibold text-sm text-left">Name</th><th class="py-3 px-4 uppercase font-semibold text-sm text-left">Roll No</th>
                        <th class="py-3 px-4 uppercase font-semibold text-sm text-left">Class</th><th class="py-3 px-4 uppercase font-semibold text-sm text-left">Guardian</th>
                        ${currentUser.role === 'Admin' ? '<th class="py-3 px-4 uppercase font-semibold text-sm text-right">Actions</th>' : ''}
                    </tr></thead><tbody id="data-table-body" class="text-default"></tbody></table></div>
                </div>`;

            const tableBody = document.getElementById('data-table-body');
            const searchInput = document.getElementById('search-input');
            const classFilter = document.getElementById('class-filter');

            async function renderTable() {
                let students = await apiService.get('students');
                if (studentDataFilter) students = students.filter(studentDataFilter);

                const searchTerm = searchInput.value.toLowerCase();
                const selectedClass = classFilter.value;

                const filteredStudents = students.filter(s => {
                    const matchesSearch = s.name.toLowerCase().includes(searchTerm) || s.email.toLowerCase().includes(searchTerm);
                    const matchesClass = !selectedClass || s.classId === selectedClass;
                    return matchesSearch && matchesClass;
                });

                if (filteredStudents.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-secondary">No students found.</td></tr>`;
                    return;
                }

                tableBody.innerHTML = filteredStudents.map(item => `
                    <tr>
                        <td class="py-3 px-4">${item.name}</td><td class="py-3 px-4">${item.rollNo}</td>
                        <td class="py-3 px-4">${classes.find(c => c.id === item.classId)?.name || 'N/A'}</td>
                        <td class="py-3 px-4">${item.guardianName}</td>
                        ${currentUser.role === 'Admin' ? `<td class="py-3 px-4 text-right">
                            <button class="text-blue-500 hover:text-blue-700 mr-2 edit-btn transform hover:scale-110 transition-transform" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                            <button class="text-red-500 hover:text-red-700 delete-btn transform hover:scale-110 transition-transform" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
                        </td>` : ''}
                    </tr>`).join('');

                attachActionListeners();
            }

            function attachActionListeners() {
                document.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = async () => {
                    const id = btn.dataset.id;
                    const student = (await apiService.get('students')).find(s => s.id === id);
                    openStudentForm('Edit Student', student);
                });
                document.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => {
                    showConfirmationModal('Are you sure you want to delete this student?', async () => {
                        await apiService.remove('students', btn.dataset.id);
                        showToast('Student deleted successfully.', 'success');
                        renderTable();
                    });
                });
            }

            async function openStudentForm(title, data = {}) {
                const classOptions = (await apiService.get('classes')).map(c => `<option value="${c.id}" ${data.classId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
                const fields = [
                    { name: 'name', label: 'Full Name', type: 'text', required: true },
                    { name: 'rollNo', label: 'Roll Number', type: 'text', required: true },
                    { name: 'classId', label: 'Class', type: 'select', options: classOptions, required: true },
                    { name: 'guardianName', label: 'Guardian Name', type: 'text', required: true },
                    { name: 'contact', label: 'Guardian Contact', type: 'tel', required: true },
                    { name: 'email', label: 'Email', type: 'email', required: true },
                    { name: 'address', label: 'Address', type: 'textarea', required: true },
                ];
                openFormModal(title, fields, async (formData) => {
                    if (data.id) {
                        await apiService.update('students', data.id, formData);
                        showToast('Student updated successfully.', 'success');
                    } else {
                        await apiService.create('students', formData);
                        showToast('Student added successfully.', 'success');
                    }
                    renderTable();
                }, data);
            }

            if (currentUser.role === 'Admin') document.getElementById('add-new-btn').onclick = () => openStudentForm('Add New Student');
            searchInput.oninput = renderTable;
            classFilter.onchange = renderTable;
            renderTable();
        }

        /**
         * Renders the Teachers page.
         */
        function renderTeachersPage() {
            renderGenericListPage({
                title: 'Teacher', collectionName: 'teachers',
                columns: [
                    { label: 'Name', key: 'name' }, { label: 'Subject', key: 'subject' },
                    { label: 'Contact', key: 'contact' }, { label: 'Email', key: 'email' }
                ],
                formFields: [
                    { name: 'name', label: 'Full Name', type: 'text', required: true },
                    { name: 'subject', label: 'Subject', type: 'text', required: true },
                    { name: 'contact', label: 'Contact', type: 'tel', required: true },
                    { name: 'email', label: 'Email', type: 'email', required: true },
                    { name: 'address', label: 'Address', type: 'textarea' },
                ]
            });
        }

        /**
         * Renders the Classes page.
         */
        async function renderClassesPage() {
            const teachers = await apiService.get('teachers');
            renderGenericListPage({
                title: 'Class', collectionName: 'classes',
                columns: [
                    { label: 'Class Name', key: 'name' },
                    { label: 'Class Teacher', render: (item) => teachers.find(t => t.id === item.teacherId)?.name || 'N/A' },
                ],
                formFields: [
                    { name: 'name', label: 'Class Name', type: 'text', required: true },
                    { name: 'teacherId', label: 'Class Teacher', type: 'select', options: teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join(''), required: true },
                ]
            });
        }

        /**
         * Renders the Fees page. Role-based filtering is applied.
         */
        async function renderFeesPage() {
            const students = await apiService.get('students');
            let config = {
                title: 'Fee', collectionName: 'fees',
                columns: [
                    { label: 'Student', render: (item) => students.find(s => s.id === item.studentId)?.name || 'N/A' },
                    { label: 'Amount', key: 'amount', render: (item) => `$${item.amount}` },
                    { label: 'Due Date', key: 'dueDate' },
                    { label: 'Status', key: 'status', render: (item) => `<span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full ${item.status === 'Paid' ? 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100' : 'bg-red-100 text-red-800 dark:bg-red-700 dark:text-red-100'}">${item.status}</span>` }
                ],
                formFields: [
                    { name: 'studentId', label: 'Student', type: 'select', options: students.map(s => `<option value="${s.id}">${s.name} (Roll: ${s.rollNo})</option>`).join(''), required: true },
                    { name: 'amount', label: 'Amount', type: 'number', required: true },
                    { name: 'dueDate', label: 'Due Date', type: 'date', required: true },
                    { name: 'status', label: 'Status', type: 'select', options: '<option value="Paid">Paid</option><option value="Unpaid">Unpaid</option>', required: true },
                ]
            };
            if (currentUser.role === 'Student') {
                config.dataFilter = (fee) => fee.studentId === currentUser.id;
                config.formFields = null; // Students cannot add/edit fees
            }
            renderGenericListPage(config);
        }

        /**
         * Renders the Attendance page. Role-based access and filtering applied.
         */
        async function renderAttendancePage() {
            const classes = await apiService.get('classes');
            let viewableClasses = classes;

            if (currentUser.role === 'Teacher') {
                viewableClasses = classes.filter(c => c.teacherId === currentUser.id);
            } else if (currentUser.role === 'Student') {
                 viewableClasses = classes.filter(c => c.id === currentUser.classId);
            }

            contentArea.innerHTML = `
                <div class="card-bg p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2 border-default">Manage Attendance</h3>
                    <div class="flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-4 mb-4">
                        <input type="date" id="attendance-date" value="${new Date().toISOString().slice(0, 10)}" class="w-full md:w-auto">
                        <select id="attendance-class" class="w-full md:w-auto">${viewableClasses.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select>
                        <button id="load-attendance-btn" class="btn-primary text-white font-bold py-2 px-4 rounded w-full md:w-auto transform hover:scale-105 transition-transform duration-200 shadow-md">Load Attendance</button>
                    </div>
                    <div id="attendance-sheet" class="mt-4"></div>
                </div>
            `;

            const loadBtn = document.getElementById('load-attendance-btn');
            loadBtn.onclick = async () => {
                const date = document.getElementById('attendance-date').value;
                const classId = document.getElementById('attendance-class').value;
                const sheetContainer = document.getElementById('attendance-sheet');

                if (!date || !classId) {
                    sheetContainer.innerHTML = `<p class="text-red-500 dark:text-red-400">Please select both date and class.</p>`;
                    return;
                }

                sheetContainer.innerHTML = `<p class="text-center py-4 text-default"><i class="fas fa-spinner fa-spin text-blue-500"></i> Loading...</p>`;

                const students = (await apiService.get('students')).filter(s => s.classId === classId);
                const attendanceRecord = await apiService.getAttendance(date, classId);

                let attendanceTableHtml = `<div class="overflow-x-auto mt-4">
                        <table class="table-auto min-w-full rounded-lg overflow-hidden"><thead><tr>
                            <th class="py-3 px-4 text-left">Student Name</th>
                            <th class="py-3 px-4 text-left">Roll No</th>
                            <th class="py-3 px-4 text-left">Status</th>
                        </tr></thead><tbody class="text-default">`;

                if (students.length === 0) {
                    attendanceTableHtml += `<tr><td colspan="3" class="text-center py-4 text-secondary">No students in this class.</td></tr>`;
                } else {
                    attendanceTableHtml += students.map(s => `
                        <tr>
                            <td class="py-3 px-4">${s.name}</td>
                            <td class="py-3 px-4">${s.rollNo}</td>
                            <td class="py-3 px-4">
                                ${currentUser.role !== 'Student' ? `
                                <select class="attendance-status w-full" data-studentid="${s.id}">
                                    <option value="Present" ${attendanceRecord?.records[s.id] === 'Present' ? 'selected' : ''}>Present</option>
                                    <option value="Absent" ${attendanceRecord?.records[s.id] === 'Absent' ? 'selected' : ''}>Absent</option>
                                    <option value="Late" ${attendanceRecord?.records[s.id] === 'Late' ? 'selected' : ''}>Late</option>
                                </select>` : `<span class="px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full ${attendanceRecord?.records[s.id] === 'Present' ? 'bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100' : attendanceRecord?.records[s.id] === 'Absent' ? 'bg-red-100 text-red-800 dark:bg-red-700 dark:text-red-100' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100'}">${attendanceRecord?.records[s.id] || 'N/A'}</span>`}
                            </td>
                        </tr>
                    `).join('');
                }
                attendanceTableHtml += `</tbody></table>`;

                if (currentUser.role !== 'Student' && students.length > 0) {
                    attendanceTableHtml += `<button id="save-attendance-btn" class="mt-6 btn-success text-white font-bold py-2 px-4 rounded transform hover:scale-105 transition-transform duration-200 shadow-md">Save Attendance</button>`;
                }
                attendanceTableHtml += `</div>`;
                sheetContainer.innerHTML = attendanceTableHtml;

                if (currentUser.role !== 'Student' && students.length > 0) {
                    document.getElementById('save-attendance-btn').onclick = async () => {
                        const records = {};
                        document.querySelectorAll('.attendance-status').forEach(select => {
                            records[select.dataset.studentid] = select.value;
                        });
                        await apiService.saveAttendance(date, classId, records);
                        showToast('Attendance saved successfully!', 'success');
                    };
                }
            };
            // Automatically load attendance for the current date if a class is pre-selected
            if (viewableClasses.length > 0) {
                document.getElementById('attendance-class').value = viewableClasses[0].id;
                loadBtn.click();
            }
        }

        /**
         * Renders the Exams and Results page. Role-based access and filtering applied.
         */
        async function renderExamsPage() {
            const exams = await apiService.get('exams');
            const classes = await apiService.get('classes');
            const subjects = await apiService.get('subjects');

            let content = `<div class="card-bg p-6 rounded-lg shadow-md">`;

            if (currentUser.role === 'Admin') {
                content += `<div class="flex justify-between items-center mb-4 border-b pb-2 border-default">
                                <h3 class="text-xl font-semibold text-default">Exams List</h3>
                                <button id="add-exam-btn" class="btn-primary text-white font-bold py-2 px-4 rounded transform hover:scale-105 transition-transform duration-200 shadow-md">Create Exam</button>
                            </div>`;
            } else if(currentUser.role === 'Teacher') {
                content += `<h3 class="text-xl font-semibold mb-4 border-b pb-2 border-default">Enter/View Results</h3>`;
            } else { // Student
                content += `<h3 class="text-xl font-semibold mb-4 border-b pb-2 border-default">My Exam Results</h3>`;
            }

            content += `<div class="space-y-4">`;
            if (exams.length === 0) {
                content += `<p class="text-center py-4 text-secondary">No exams scheduled yet.</p>`;
            } else {
                for (const exam of exams) {
                    let shouldShow = true;
                    if (currentUser.role === 'Student') {
                        shouldShow = currentUser.classId === exam.classId;
                    } else if (currentUser.role === 'Teacher') {
                        const teacherClassIds = classes.filter(c => c.teacherId === currentUser.id).map(c => c.id);
                        shouldShow = teacherClassIds.includes(exam.classId);
                    }

                    if (shouldShow) {
                        content += `
                            <div class="p-4 border border-default rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                                    <div>
                                        <p class="font-bold text-lg text-default">${exam.name} - ${classes.find(c => c.id === exam.classId)?.name || ''}</p>
                                        <p class="text-sm text-secondary">Subject: ${subjects.find(s => s.id === exam.subjectId)?.name || ''} | Date: ${exam.date} | Max Marks: ${exam.maxMarks}</p>
                                    </div>
                                    <button class="view-results-btn mt-3 md:mt-0 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded transform hover:scale-105 transition-transform duration-200 shadow-sm" data-examid="${exam.id}" data-examname="${exam.name}" data-maxmarks="${exam.maxMarks}">
                                        ${currentUser.role === 'Teacher' ? 'Enter/View Results' : 'View Results'}
                                    </button>
                                </div>
                                <div id="results-container-${exam.id}" class="hidden mt-4 pt-4 border-t border-default"></div>
                            </div>`;
                    }
                }
            }
            content += `</div></div>`;
            contentArea.innerHTML = content;

            if (currentUser.role === 'Admin') {
                document.getElementById('add-exam-btn').onclick = () => {
                     openFormModal('Create New Exam', [
                        { name: 'name', label: 'Exam Name', type: 'text', required: true },
                        { name: 'classId', label: 'Class', type: 'select', options: classes.map(c=>`<option value="${c.id}">${c.name}</option>`).join(''), required: true },
                        { name: 'subjectId', label: 'Subject', type: 'select', options: subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''), required: true },
                        { name: 'date', label: 'Date', type: 'date', required: true },
                        { name: 'maxMarks', label: 'Max Marks', type: 'number', required: true },
                     ], async (formData) => {
                         await apiService.create('exams', formData);
                         showToast('Exam created successfully', 'success');
                         renderExamsPage();
                     });
                };
            }

            document.querySelectorAll('.view-results-btn').forEach(btn => {
                btn.onclick = async (e) => {
                    const examId = e.currentTarget.dataset.examid;
                    const examName = e.currentTarget.dataset.examname;
                    const maxMarks = e.currentTarget.dataset.maxmarks;
                    const container = document.getElementById(`results-container-${examId}`);

                    // Toggle visibility
                    if (!container.classList.contains('hidden')) {
                        container.classList.add('hidden');
                        container.innerHTML = '';
                        return;
                    }

                    container.classList.remove('hidden');
                    container.innerHTML = `<p class="text-center py-4 text-default"><i class="fas fa-spinner fa-spin text-blue-500"></i> Loading results...</p>`;

                    const exam = (await apiService.get('exams')).find(ex => ex.id === examId);
                    const allStudents = await apiService.get('students');
                    const studentsInClass = allStudents.filter(s => s.classId === exam.classId);
                    const results = await apiService.getResultsForExam(examId);

                    let resultsHtml = `<h4 class="font-semibold text-lg mb-3 text-default">Results for ${examName}</h4>`;

                    if (currentUser.role === 'Student') {
                        const myResult = results.find(r => r.studentId === currentUser.id);
                        resultsHtml += myResult
                            ? `<p class="text-xl font-bold text-green-600 dark:text-green-400">Your Score: ${myResult.marks} / ${maxMarks}</p>`
                            : `<p class="text-red-500 dark:text-red-400">Your result is not available yet.</p>`;
                    } else { // Admin or Teacher
                        if (studentsInClass.length === 0) {
                            resultsHtml += `<p class="text-center py-4 text-secondary">No students found in this class for results entry.</p>`;
                        } else {
                            resultsHtml += `<div class="overflow-x-auto"><table class="table-auto min-w-full rounded-lg overflow-hidden">
                                <thead><tr>
                                    <th class="py-2 px-3 text-left border-b-2 border-default">Student Name</th>
                                    <th class="py-2 px-3 text-left border-b-2 border-default">Marks (out of ${maxMarks})</th>
                                </tr></thead><tbody>`;

                            for (const student of studentsInClass) {
                                const result = results.find(r => r.studentId === student.id);
                                resultsHtml += `<tr>
                                    <td class="py-3 px-4">${student.name}</td>
                                    <td class="py-3 px-4">
                                        ${currentUser.role === 'Teacher'
                                            ? `<input type="number" class="marks-input w-24" data-studentid="${student.id}" value="${result?.marks || ''}" min="0" max="${maxMarks}">`
                                            : (result?.marks !== undefined ? result.marks : '<span class="text-secondary">N/A</span>')
                                        }
                                    </td></tr>`;
                            }
                            resultsHtml += `</tbody></table></div>`;

                            if (currentUser.role === 'Teacher') {
                                resultsHtml += `<button class="save-results-btn mt-6 btn-success text-white font-bold py-2 px-4 rounded transform hover:scale-105 transition-transform duration-200 shadow-md" data-examid="${examId}">Save Marks</button>`;
                            }
                        }
                    }
                    container.innerHTML = resultsHtml;

                    if (currentUser.role === 'Teacher' && studentsInClass.length > 0) {
                        container.querySelector('.save-results-btn').onclick = async (event) => {
                            const examIdToSave = event.currentTarget.dataset.examid;
                            const marksData = [];
                            let hasInvalidMarks = false;
                            container.querySelectorAll('.marks-input').forEach(input => {
                                const marks = parseInt(input.value);
                                if (isNaN(marks) || marks < 0 || marks > maxMarks) {
                                    hasInvalidMarks = true;
                                    input.classList.add('border-red-500', 'ring-red-500'); // Highlight invalid input
                                } else {
                                    input.classList.remove('border-red-500', 'ring-red-500');
                                    marksData.push({ studentId: input.dataset.studentid, marks: marks });
                                }
                            });

                            if (hasInvalidMarks) {
                                showToast('Please enter valid marks (0 - ' + maxMarks + ') for all students.', 'error');
                                return;
                            }

                            await apiService.saveResults(examIdToSave, marksData);
                            showToast('Marks saved successfully!', 'success');
                            // Re-render the results to show updated values if necessary
                            // For simplicity, we just leave it as is after saving
                        };
                    }
                };
            });
        }

        /**
         * Renders the Profile page, allowing image upload for Teachers and Students.
         */
        async function renderProfilePage() {
            let additionalInfoHtml = '';
            let profileData = { ...currentUser }; // Use a copy to allow fetching more details

            if (currentUser.role === 'Student') {
                const studentDetails = (await apiService.get('students')).find(s => s.id === currentUser.id);
                if (studentDetails) profileData = { ...profileData, ...studentDetails };
                const classes = await apiService.get('classes');
                const myClass = classes.find(c => c.id === profileData.classId)?.name || 'N/A';
                additionalInfoHtml = `
                    <div><p class="font-semibold text-secondary">Roll No:</p><p class="text-default">${profileData.rollNo || 'N/A'}</p></div>
                    <div><p class="font-semibold text-secondary">Class:</p><p class="text-default">${myClass}</p></div>
                    <div><p class="font-semibold text-secondary">Guardian Name:</p><p class="text-default">${profileData.guardianName || 'N/A'}</p></div>
                `;
            } else if (currentUser.role === 'Teacher') {
                const teacherDetails = (await apiService.get('teachers')).find(t => t.id === currentUser.id);
                if (teacherDetails) profileData = { ...profileData, ...teacherDetails };
                additionalInfoHtml = `
                    <div><p class="font-semibold text-secondary">Subject:</p><p class="text-default">${profileData.subject || 'N/A'}</p></div>
                `;
            }

            contentArea.innerHTML = `
                <div class="card-bg p-8 rounded-lg shadow-md max-w-2xl mx-auto transform hover:scale-[1.01] transition-transform duration-200">
                    <h3 class="text-2xl font-bold text-default mb-6 border-b border-default pb-4">My Profile</h3>
                    <div class="flex flex-col items-center mb-6">
                        <div class="profile-image-upload-wrapper">
                            <img id="profile-img-preview" src="${profileData.profileImage || DEFAULT_PROFILE_IMAGE}" alt="Profile Picture" class="profile-image-preview shadow-md">
                            <input type="file" id="profile-image-upload" accept="image/*">
                            <label for="profile-image-upload" class="overlay-icon">
                                <i class="fas fa-camera"></i>
                            </label>
                        </div>
                        <p class="text-xl font-bold text-default mt-4">${profileData.name}</p>
                        <p class="text-md text-secondary">${profileData.role}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><p class="font-semibold text-secondary">Email:</p><p class="font-medium text-default">${profileData.email}</p></div>
                        ${currentUser.role !== 'Admin' ? `
                        <div><p class="font-semibold text-secondary">Contact:</p><p class="font-medium text-default">${profileData.contact || 'N/A'}</p></div>
                        <div><p class="font-semibold text-secondary">Address:</p><p class="font-medium text-default">${profileData.address || 'N/A'}</p></div>` : ''}
                        ${additionalInfoHtml}
                    </div>
                </div>`;

            // Profile image upload logic
            document.getElementById('profile-image-upload').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const imageData = e.target.result;
                        document.getElementById('profile-img-preview').src = imageData;
                        headerUserAvatar.src = imageData; // Update header avatar

                        // Update current user and database
                        currentUser.profileImage = imageData;
                        sessionStorage.setItem('sms_user', JSON.stringify(currentUser)); // Update session storage

                        if (currentUser.role === 'Student') {
                            await apiService.update('students', currentUser.id, { profileImage: imageData });
                        } else if (currentUser.role === 'Teacher') {
                            await apiService.update('teachers', currentUser.id, { profileImage: imageData });
                        } else if (currentUser.role === 'Admin') {
                            // Admins are in mockUsers, so update that directly
                            mockUsers['admin'].profileImage = imageData;
                            // Then update the session storage to reflect the change
                        }
                        showToast('Profile image updated!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        /**
         * Renders the Notice Board page.
         */
        async function renderNoticesPage() {
            contentArea.innerHTML = `
                <div class="card-bg p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-default">
                        <h3 class="text-xl font-semibold text-default">Notice Board</h3>
                        ${currentUser.role === 'Admin' ? `<button id="add-new-btn" class="btn-primary text-white font-bold py-2 px-4 rounded transform hover:scale-105 transition-transform duration-200 shadow-md">Add New Notice</button>` : ''}
                    </div>
                    <div id="notice-list" class="space-y-4"></div>
                </div>`;

            const noticeListContainer = document.getElementById('notice-list');

            async function renderList() {
                let notices = await apiService.get('notices');

                // Filter notices based on user role and specific recipient IDs
                const filteredNotices = notices.filter(n =>
                    n.target === 'All' || n.target === currentUser.role || (n.target === currentUser.id && currentUser.role === 'Student') || (n.target === currentUser.id && currentUser.role === 'Teacher')
                ).sort((a, b) => new Date(b.date) - new Date(a.date));

                if (filteredNotices.length === 0) {
                    noticeListContainer.innerHTML = '<p class="text-center py-4 text-secondary">No notices found.</p>';
                    return;
                }

                noticeListContainer.innerHTML = filteredNotices.map(item => `
                    <div class="p-4 border border-default rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg text-default">${item.title}
                                    <span class="text-sm font-normal text-secondary">(${item.date})</span>
                                    ${item.senderRole && item.senderRole !== 'Admin' ? `<span class="ml-2 px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100">${item.senderRole} Message</span>` : ''}
                                </p>
                                <p class="mt-2 text-default">${item.content}</p>
                            </div>
                            ${currentUser.role === 'Admin' ? `
                            <div class="flex-shrink-0 ml-4">
                                <button class="text-blue-500 hover:text-blue-700 mr-2 edit-btn transform hover:scale-110 transition-transform" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                                <button class="text-red-500 hover:text-red-700 delete-btn transform hover:scale-110 transition-transform" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
                            </div>` : ''}
                        </div>
                    </div>`).join('');

                attachActionListeners();
            }

            function attachActionListeners() {
                document.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = async () => {
                    const id = btn.dataset.id;
                    const notice = (await apiService.get('notices')).find(n => n.id === id);
                    openNoticeForm('Edit Notice', notice);
                });
                document.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => {
                    showConfirmationModal('Are you sure you want to delete this notice?', async () => {
                        await apiService.remove('notices', btn.dataset.id);
                        showToast('Notice deleted successfully.', 'success');
                        renderList();
                    });
                });
            }

            function openNoticeForm(title, data = {}) {
                const fields = [
                    { name: 'title', label: 'Title', type: 'text', required: true },
                    { name: 'content', label: 'Content', type: 'textarea', required: true },
                    { name: 'date', label: 'Date', type: 'date', required: true },
                    { name: 'target', label: 'Target Audience', type: 'select', options: '<option value="All">All</option><option value="Student">Students</option><option value="Teacher">Teachers</option>', required: true },
                ];
                // Set default date if not provided
                if (!data.date) {
                    data.date = new Date().toISOString().slice(0, 10);
                }
                openFormModal(title, fields, async (formData) => {
                    const newNotice = {
                        ...formData,
                        senderId: currentUser.id,
                        senderRole: currentUser.role
                    };
                    if (data.id) {
                        await apiService.update('notices', data.id, newNotice);
                        showToast('Notice updated successfully.', 'success');
                    } else {
                        await apiService.create('notices', newNotice);
                        showToast('Notice added successfully.', 'success');
                    }
                    renderList();
                }, data);
            }

            if (currentUser.role === 'Admin') {
                document.getElementById('add-new-btn').onclick = () => openNoticeForm('Add New Notice');
            }

            renderList();
        }

        /**
         * Renders the "Message Students" page for teachers.
         */
        async function renderMessageStudentsPage() {
            const teacherClasses = (await apiService.get('classes')).filter(c => c.teacherId === currentUser.id);
            const allStudents = await apiService.get('students');

            let classOptionsHtml = teacherClasses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            if (teacherClasses.length > 0) {
                 classOptionsHtml = `<option value="">Select a Class (All my students)</option>` + classOptionsHtml;
            } else {
                classOptionsHtml = `<option value="">No classes assigned</option>`;
            }


            contentArea.innerHTML = `
                <div class="card-bg p-6 rounded-lg shadow-md max-w-lg mx-auto">
                    <h3 class="text-xl font-semibold text-default mb-4 border-b pb-2 border-default">Send Message to Students</h3>
                    <form id="message-students-form" class="space-y-4">
                        <div>
                            <label for="message-class-select" class="block text-secondary text-sm font-bold mb-2">Select Class (optional)</label>
                            <select id="message-class-select" class="w-full">${classOptionsHtml}</select>
                            <p class="text-xs text-secondary mt-1">Leave blank to send to all students in your assigned classes.</p>
                        </div>
                        <div>
                            <label for="message-title" class="block text-secondary text-sm font-bold mb-2">Message Title</label>
                            <input type="text" id="message-title" required class="w-full">
                        </div>
                        <div>
                            <label for="message-content" class="block text-secondary text-sm font-bold mb-2">Message Content</label>
                            <textarea id="message-content" rows="6" required class="w-full"></textarea>
                        </div>
                        <button type="submit" class="btn-primary text-white font-bold py-2 px-4 rounded transform hover:scale-105 transition-transform duration-200 shadow-md">Send Message</button>
                    </form>
                </div>
            `;

            document.getElementById('message-students-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const classId = document.getElementById('message-class-select').value;
                const title = document.getElementById('message-title').value;
                const content = document.getElementById('message-content').value;
                const currentDate = new Date().toISOString().slice(0, 10);

                if (!title || !content) {
                    showToast('Title and content are required!', 'error');
                    return;
                }

                const studentsToMessage = [];
                if (classId) {
                    // Message specific class
                    studentsToMessage.push(...allStudents.filter(s => s.classId === classId));
                } else {
                    // Message all students in teacher's classes
                    teacherClasses.forEach(tClass => {
                        studentsToMessage.push(...allStudents.filter(s => s.classId === tClass.id));
                    });
                }

                if (studentsToMessage.length === 0) {
                    showToast('No students found in selected class(es) to send message.', 'error');
                    return;
                }

                // For simplicity, create a general notice for students and individual notices for each student
                // A real system would use a dedicated messaging table or notifications.
                await apiService.create('notices', {
                    title: `Message from ${currentUser.name}: ${title}`,
                    content: content,
                    date: currentDate,
                    target: 'Student', // Target all students (will be filtered by class for actual display)
                    senderId: currentUser.id,
                    senderRole: currentUser.role
                });

                showToast(`Message sent to ${studentsToMessage.length} students!`, 'success');
                e.target.reset();
            });
        }

        /**
         * Renders the "Contact Teacher" page for students.
         */
        async function renderContactTeacherPage() {
            const myClass = (await apiService.get('classes')).find(c => c.id === currentUser.classId);
            const classTeacher = myClass ? (await apiService.get('teachers')).find(t => t.id === myClass.teacherId) : null;

            contentArea.innerHTML = `
                <div class="card-bg p-6 rounded-lg shadow-md max-w-lg mx-auto">
                    <h3 class="text-xl font-semibold text-default mb-4 border-b pb-2 border-default">Contact My Teacher</h3>
                    ${classTeacher ? `
                        <p class="text-default mb-4">You can contact your class teacher, <strong>${classTeacher.name}</strong> (${classTeacher.email}).</p>
                        <form id="contact-teacher-form" class="space-y-4">
                            <div>
                                <label for="message-subject" class="block text-secondary text-sm font-bold mb-2">Subject</label>
                                <input type="text" id="message-subject" required class="w-full">
                            </div>
                            <div>
                                <label for="message-body" class="block text-secondary text-sm font-bold mb-2">Your Message</label>
                                <textarea id="message-body" rows="8" required class="w-full"></textarea>
                            </div>
                            <button type="submit" class="btn-primary text-white font-bold py-2 px-4 rounded transform hover:scale-105 transition-transform duration-200 shadow-md">Send Message</button>
                        </form>
                    ` : `
                        <p class="text-red-500 dark:text-red-400">Your class teacher information is not available.</p>
                    `}
                </div>
            `;

            if (classTeacher) {
                document.getElementById('contact-teacher-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const subject = document.getElementById('message-subject').value;
                    const body = document.getElementById('message-body').value;
                    const currentDate = new Date().toISOString().slice(0, 10);

                    // Simulate sending an email/message by creating a notice for the teacher
                    await apiService.create('notices', {
                        title: `Message from Student ${currentUser.name}: ${subject}`,
                        content: body + ` (Student Email: ${currentUser.email})`,
                        date: currentDate,
                        target: classTeacher.id, // Target only the specific teacher
                        senderId: currentUser.id,
                        senderRole: currentUser.role
                    });

                    showToast('Message sent to your teacher!', 'success');
                    e.target.reset();
                });
            }
        }


        // ===================================================================================
        // --- GENERIC & HELPER FUNCTIONS (MODALS, TOASTS) ---
        // ===================================================================================

        /**
         * Renders a generic list page with CRUD functionality for Admin.
         * @param {object} config - Configuration for the list page.
         * @param {string} config.title - Title of the entities (e.g., 'Student', 'Teacher').
         * @param {string} config.collectionName - Name of the collection in appDatabase (e.g., 'students').
         * @param {Array<object>} config.columns - Array of column definitions ({ label, key, render }).
         * @param {Array<object>} [config.formFields] - Array of form field definitions for add/edit operations. If null, no add/edit options.
         * @param {function} [config.dataFilter] - Optional function to filter data based on user role.
         */
        async function renderGenericListPage(config) {
            const { title, collectionName, columns, formFields, dataFilter } = config;

            contentArea.innerHTML = `
                <div class="card-bg p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 border-default">
                        <h3 class="text-xl font-semibold text-default">${title} List</h3>
                        ${(currentUser.role === 'Admin' && formFields) ? `<button id="add-new-btn" class="btn-primary text-white font-bold py-2 px-4 rounded transform hover:scale-105 transition-transform duration-200 shadow-md">Add New ${title}</button>` : ''}
                    </div>
                    <div class="overflow-x-auto"><table class="table-auto min-w-full rounded-lg overflow-hidden"><thead><tr>
                        ${columns.map(col => `<th class="py-3 px-4 uppercase font-semibold text-sm text-left">${col.label}</th>`).join('')}
                        ${(currentUser.role === 'Admin' && formFields) ? '<th class="py-3 px-4 uppercase font-semibold text-sm text-right">Actions</th>' : ''}
                    </tr></thead><tbody id="data-table-body" class="text-default"></tbody></table></div>
                </div>`;

            const tableBody = document.getElementById('data-table-body');

            async function renderTable() {
                let dataList = await apiService.get(collectionName);
                if(dataFilter) dataList = dataList.filter(dataFilter);

                if (!dataList || dataList.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${columns.length + (currentUser.role === 'Admin' && formFields ? 1 : 0)}" class="text-center py-4 text-secondary">No ${collectionName} found.</td></tr>`;
                    return;
                }

                tableBody.innerHTML = dataList.map(item => `
                    <tr>
                        ${columns.map(col => `<td class="py-3 px-4">${col.render ? col.render(item) : (item[col.key] || 'N/A')}</td>`).join('')}
                        ${(currentUser.role === 'Admin' && formFields) ? `
                            <td class="py-3 px-4 text-right">
                                <button class="text-blue-500 hover:text-blue-700 mr-2 edit-btn transform hover:scale-110 transition-transform" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                                <button class="text-red-500 hover:text-red-700 delete-btn transform hover:scale-110 transition-transform" data-id="${item.id}"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        ` : ''}
                    </tr>`).join('');

                attachActionListeners();
            }

            function attachActionListeners() {
                document.querySelectorAll('.edit-btn').forEach(btn => btn.onclick = async () => {
                    const id = btn.dataset.id;
                    const item = (await apiService.get(collectionName)).find(i => i.id === id);
                    openFormModal(`Edit ${title}`, formFields, async (formData) => {
                        await apiService.update(collectionName, id, formData);
                        showToast(`${title} updated successfully.`, 'success');
                        renderTable();
                    }, item);
                });
                document.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = () => {
                    showConfirmationModal(`Are you sure you want to delete this ${title}?`, async () => {
                        await apiService.remove(collectionName, btn.dataset.id);
                        showToast(`${title} deleted successfully.`, 'success');
                        renderTable();
                    });
                });
            }

            if (currentUser.role === 'Admin' && formFields) {
                document.getElementById('add-new-btn').addEventListener('click', () => openFormModal(`Add New ${title}`, formFields, async (formData) => {
                    await apiService.create(collectionName, formData);
                    showToast(`${title} added successfully.`, 'success');
                    renderTable();
                }));
            }

            renderTable();
        }

        /**
         * Opens a generic form modal for adding/editing data.
         * @param {string} title - The title of the modal.
         * @param {Array<object>} fields - An array of field definitions.
         * @param {function} onSubmit - The function to call when the form is submitted.
         * @param {object} [data={}] - Initial data to populate the form fields.
         */
        function openFormModal(title, fields, onSubmit, data = {}) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = `
                <form id="dynamic-form" class="space-y-5">
                    ${fields.map(field => {
                        const value = data[field.name] !== undefined ? data[field.name] : '';
                        const baseClasses = "w-full"; // Tailwind classes will be applied by global styles

                        let fieldHtml;
                        switch(field.type) {
                            case 'textarea':
                                fieldHtml = `<textarea id="${field.name}" name="${field.name}" rows="4" class="${baseClasses}" ${field.required ? 'required' : ''}>${value}</textarea>`;
                                break;
                            case 'select':
                                fieldHtml = `<select id="${field.name}" name="${field.name}" class="${baseClasses}" ${field.required ? 'required' : ''}>${field.options}</select>`;
                                break;
                            default:
                                fieldHtml = `<input type="${field.type}" id="${field.name}" name="${field.name}" value="${value}" class="${baseClasses}" ${field.required ? 'required' : ''}>`;
                        }
                        return `<div><label for="${field.name}" class="block text-secondary text-sm font-bold mb-2">${field.label}</label>${fieldHtml}</div>`;
                    }).join('')}
                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" class="btn-primary text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transform hover:scale-105 transition-transform duration-200 shadow-md">Save</button>
                    </div>
                </form>`;

            // Set default values for select elements, as value attribute doesn't work directly
            fields.forEach(field => {
                if (field.type === 'select' && data[field.name]) {
                    const selectElement = document.getElementById(field.name);
                    if (selectElement) {
                        selectElement.value = data[field.name];
                    }
                }
            });

            modal.classList.add('show');
            modal.style.display = 'flex'; // Ensure flex display
            document.getElementById('dynamic-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = Object.fromEntries(new FormData(e.target));
                onSubmit(formData);
                closeModal();
            });
        }

        /**
         * Closes the form modal.
         */
        function closeModal() {
            modal.classList.remove('show');
            setTimeout(() => { modal.style.display = 'none'; }, 300); // Hide after transition
        }

        /**
         * Closes the confirmation modal.
         */
        function closeConfirmationModal() {
            confirmModal.classList.remove('show');
            setTimeout(() => { confirmModal.style.display = 'none'; }, 300); // Hide after transition
        }

        /**
         * Shows a confirmation modal.
         * @param {string} text - The confirmation message.
         * @param {function} onConfirm - The callback function to execute on confirmation.
         */
        function showConfirmationModal(text, onConfirm) {
            document.getElementById('confirm-text').textContent = text;
            confirmModal.classList.add('show');
            confirmModal.style.display = 'flex';
            // Clone and replace the 'Yes' button to remove previous event listeners
            const oldYesBtn = document.getElementById('confirm-yes-btn');
            const newYesBtn = oldYesBtn.cloneNode(true);
            oldYesBtn.parentNode.replaceChild(newYesBtn, oldYesBtn);
            newYesBtn.addEventListener('click', () => {
                onConfirm();
                closeConfirmationModal();
            }, { once: true }); // Use {once: true} to prevent multiple triggers if modal is reused quickly
        }

        /**
         * Displays a toast notification.
         * @param {string} message - The message to display.
         * @param {string} type - The type of toast ('success', 'error', 'info').
         */
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            // Add icon based on type
            if (type === 'success') toast.innerHTML = '<i class="fas fa-check-circle"></i> ' + message;
            else if (type === 'error') toast.innerHTML = '<i class="fas fa-times-circle"></i> ' + message;
            else toast.innerHTML = message;

            toastContainer.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => { toast.remove(); }, 500); // Remove after fade out
            }, 3000);
        }
    </script>
</body>
</html>